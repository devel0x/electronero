<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ t.title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script>
    const SERVER_PORT = '{{ server_port }}';
    function apiUrl(path){
        return `${window.location.protocol}//${window.location.hostname}:${SERVER_PORT}${path}`;
    }
    const taskNames = [
        'telegram','x','discord','web_wallet','mobile_wallet','newsletter','reddit','tweet'
    ];
    const taskLabels = {
        telegram: '{{ t.join_telegram }}',
        x: '{{ t.follow_x }}',
        discord: '{{ t.join_discord }}',
        web_wallet: '{{ t.register_web_wallet }}',
        mobile_wallet: '{{ t.register_mobile_wallet }}',
        newsletter: '{{ t.subscribe_newsletter }}',
        reddit: '{{ t.follow_reddit }}',
        tweet: '{{ t.share_tweet }}'
    };

    function saveCreds(){
        localStorage.setItem('username', document.getElementById('username').value);
        localStorage.setItem('password', document.getElementById('password').value);
        localStorage.setItem('user_id', document.getElementById('user_id').value);
    }

    function authHeaders(){
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const headers = {'Content-Type': 'application/json'};
        if(u && p){
            headers['Authorization'] = 'Basic ' + btoa(u + ':' + p);
        }
        return headers;
    }

    async function completeTask(taskName){
        const userId = document.getElementById('user_id').value;
        const response = await fetch(apiUrl(`/tasks/${userId}`), {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({task_name: taskName, completed: true})
        });
        const msg = await response.json();
        alert(msg.message || msg.detail);
        loadProgress();
    }

    async function claimReward(){
        const userId = document.getElementById('user_id').value;
        const response = await fetch(apiUrl(`/claim/${userId}`), {method: 'POST', headers: authHeaders()});
        const msg = await response.json();
        alert(msg.message || msg.detail);
        loadProgress();
    }

    async function saveWallet(){
        const userId = document.getElementById('user_id').value;
        const address = document.getElementById('wallet_address').value;
        const response = await fetch(apiUrl('/payout_address'), {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({user_id: parseInt(userId), address})
        });
        const msg = await response.json();
        alert(msg.message || msg.detail);
    }

    function updateReferral(){
        const base = "{{ links.referral_base }}";
        const userId = document.getElementById('user_id').value;
        const span = document.getElementById('referral_link');
        span.textContent = base && userId ? `${base}?ref=${userId}` : '';
        loadProgress();
    }

    async function loadProgress(){
        const userId = document.getElementById('user_id').value;
        if(!userId){return;}
        const resp = await fetch(apiUrl(`/progress/${userId}`), {headers: authHeaders()});
        if(!resp.ok){return;}
        const data = await resp.json();
        document.getElementById('points').textContent = `${data.points} {{ t.points_label }}`;
        const ul = document.getElementById('progress_list');
        ul.innerHTML = '';
        taskNames.forEach(n => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            const done = data.completed_tasks.includes(n);
            li.innerHTML = `<input class="form-check-input me-2" type="checkbox" ${done ? 'checked' : ''} disabled> ${taskLabels[n]}`;
            ul.appendChild(li);
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('username').value = localStorage.getItem('username') || '';
        document.getElementById('password').value = localStorage.getItem('password') || '';
        document.getElementById('user_id').value = localStorage.getItem('user_id') || '';
        updateReferral();
        loadProgress();
    });
    </script>
</head>
<body>
    <header class="d-flex align-items-center p-3">
        <img src="/static/logo.png" class="logo" alt="Logo">
        <h1>{{ t.title }}</h1>
    </header>
    <div class="main-container container my-4">
    <h2>{{ t.intro_heading }}</h2>
    <p>{{ t.intro_text }}</p>
    <p>{{ t.instructions }}</p>
    <div class="mb-3">
        <label for="username" class="form-label">Username</label>
        <input id="username" class="form-control" placeholder="Your username" oninput="saveCreds()" />
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input id="password" type="password" class="form-control" oninput="saveCreds()" />
    </div>
    <div class="mb-3">
        <label for="user_id" class="form-label">User ID</label>
        <input id="user_id" class="form-control" placeholder="Enter your user id" oninput="saveCreds();updateReferral()" />
    </div>
    <div class="mb-3">
        <label for="wallet_address" class="form-label">Wallet</label>
        <input id="wallet_address" class="form-control" placeholder="Your ITC address" />
    </div>
    <button class="btn btn-secondary mb-3" onclick="saveWallet()">Save Address</button>
    <h2>{{ t.progress_heading }}</h2>
    <p id="points"></p>
    <ul id="progress_list" class="list-group mb-3"></ul>
    <ul class="list-group mb-3">
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.telegram }}" target="_blank">Telegram</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('telegram')">{{ t.join_telegram }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.x_profile }}" target="_blank">X Profile</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('x')">{{ t.follow_x }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.discord }}" target="_blank">Discord</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('discord')">{{ t.join_discord }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.web_wallet }}" target="_blank">Web Wallet</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('web_wallet')">{{ t.register_web_wallet }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.mobile_wallet }}" target="_blank">Mobile Wallet</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('mobile_wallet')">{{ t.register_mobile_wallet }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.newsletter }}" target="_blank">Newsletter</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('newsletter')">{{ t.subscribe_newsletter }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.reddit }}" target="_blank">Reddit</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('reddit')">{{ t.follow_reddit }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.tweet }}" target="_blank">Tweet</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('tweet')">{{ t.share_tweet }}</button>
        </li>
    </ul>
    <button class="btn btn-success mb-3" onclick="claimReward()">{{ t.claim_reward }}</button>
    <p>
        {{ t.referral_link }}
        <span id="referral_link"></span>
    </p>
    <p><a href="/login">Login</a> | <a href="/register">Register</a></p>
    </div>
    <footer>
        Source code available on GitHub | <a href="https://interchained.com" target="_blank">interchained.com</a> | Interchained Labs ðŸ§ª 2025
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
