<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ t.title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script>
    const SERVER_PORT = '{{ server_port }}';
    function apiUrl(path){
        return `${window.location.protocol}//${window.location.hostname}:${SERVER_PORT}${path}`;
    }
    const REWARD_THRESHOLD = {{ reward_threshold }};
    const CLAIM_DATE_STR = "{{ claim_date }}";
    const CLAIM_DATE = CLAIM_DATE_STR ? new Date(CLAIM_DATE_STR) : null;
    const taskNames = [
        'telegram','x','discord','web_wallet','mobile_wallet','newsletter','reddit','tweet','referral_share'
    ];
    const taskLabels = {
        telegram: '{{ t.join_telegram }}',
        x: '{{ t.follow_x }}',
        discord: '{{ t.join_discord }}',
        web_wallet: '{{ t.register_web_wallet }}',
        mobile_wallet: '{{ t.register_mobile_wallet }}',
        newsletter: '{{ t.subscribe_newsletter }}',
        reddit: '{{ t.follow_reddit }}',
        tweet: '{{ t.share_tweet }}',
        referral_share: '{{ t.share_referral }}'
    };

    function showAlert(message){
        document.getElementById('alertModalBody').textContent = message;
        const modal = new bootstrap.Modal(document.getElementById('alertModal'));
        modal.show();
    }

    function authHeaders(){
        const u = localStorage.getItem('username');
        const p = localStorage.getItem('password');
        const headers = {'Content-Type': 'application/json'};
        if(u && p){
            headers['Authorization'] = 'Basic ' + btoa(u + ':' + p);
        }
        return headers;
    }

    async function completeTask(taskName){
        const userId = localStorage.getItem('user_id');
        const response = await fetch(apiUrl(`/tasks/${userId}`), {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({task_name: taskName, completed: true})
        });
        const msg = await response.json();
        showAlert(msg.message || msg.detail);
        loadProgress();
    }

    async function claimReward(){
        if(CLAIM_DATE && new Date() < CLAIM_DATE){
            showCountdown();
            return;
        }
        const userId = localStorage.getItem('user_id');
        const response = await fetch(apiUrl(`/claim/${userId}`), {method: 'POST', headers: authHeaders()});
        const msg = await response.json();
        showAlert(msg.message || msg.detail);
        loadProgress();
    }


    function updateReferral(){
        const base = "{{ links.referral_base }}";
        const userId = localStorage.getItem('user_id');
        const span = document.getElementById('referral_link');
        if(!base || !userId){
            span.textContent = '';
            document.getElementById('copy_btn').classList.add('d-none');
        } else if(base.includes('?ref=')){
            span.textContent = `${base}${userId}`;
            document.getElementById('copy_btn').classList.remove('d-none');
        } else {
            span.textContent = `${base}?ref=${userId}`;
            document.getElementById('copy_btn').classList.remove('d-none');
        }
        loadProgress();
    }

    function copyReferral(){
        const text = document.getElementById('referral_link').textContent;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.getElementById('copy_btn');
            const old = btn.textContent;
            btn.textContent = '{{ t.copied }}';
            setTimeout(() => {btn.textContent = old;}, 1000);
        });
    }

    function showCountdown(){
        const body = document.getElementById('countdownBody');
        function update(){
            const now = new Date();
            const diff = CLAIM_DATE - now;
            if(diff <= 0){
                body.textContent = '{{ t.claim_now }}';
                clearInterval(timer);
                return;
            }
            const d = Math.floor(diff/86400000);
            const h = Math.floor((diff%86400000)/3600000);
            const m = Math.floor((diff%3600000)/60000);
            const s = Math.floor((diff%60000)/1000);
            body.textContent = '{{ t.claim_in }} ' + `${d}d ${h}h ${m}m ${s}s`;
        }
        update();
        const timer = setInterval(update,1000);
        const modal = new bootstrap.Modal(document.getElementById('countdownModal'));
        modal.show();
    }
    
        const userId = localStorage.getItem('user_id');
        if(!userId){return;}
        const resp = await fetch(apiUrl(`/progress/${userId}`), {headers: authHeaders()});
        if(!resp.ok){return;}
        const data = await resp.json();
        document.getElementById('points').textContent = `${data.base_points} x (1 + 0.01*${data.referral_count}) = ${data.points} {{ t.points_label }}`;
        const pct = Math.min(100, 100 * data.base_points / REWARD_THRESHOLD);
        document.getElementById('points_bar').style.width = pct + '%';
        document.getElementById('progress_text').textContent = `${data.base_points}/${REWARD_THRESHOLD} {{ t.points_label }}`;
        const ul = document.getElementById('progress_list');
        ul.innerHTML = '';
        taskNames.forEach(n => {
            const li = document.createElement('li');
            const done = data.completed_tasks.includes(n);
            li.className = `list-group-item todo-item d-flex align-items-center${done ? ' completed' : ''}`;
            li.innerHTML = `<input class="form-check-input me-2" type="checkbox" ${done ? 'checked' : ''} disabled>` +
                          `<label class="form-check-label">${taskLabels[n]}</label>`;
            ul.appendChild(li);
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
        updateReferral();
        const userLinks = document.querySelector('.user-links');
        const authLinks = document.querySelector('.auth-links');
        if(localStorage.getItem('user_id')){
            userLinks.classList.remove('d-none');
            authLinks.classList.add('d-none');
        }
    });
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="/static/logo.png" class="logo me-2" alt="Logo">
                {{ t.title }}
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto auth-links">
                    <li class="nav-item"><a class="nav-link" href="/login">Login</a></li>
                    <li class="nav-item"><a class="nav-link" href="/register">Register</a></li>
                </ul>
                <ul class="navbar-nav ms-auto user-links d-none">
                    <li class="nav-item"><a class="nav-link" href="{{ links.website }}" target="_blank">Website</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ links.whitepaper }}" target="_blank">Whitepaper</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="main-container container my-4">
    <h2>{{ t.intro_heading }}</h2>
    <p>{{ t.intro_text }}</p>
    <p>{{ t.instructions }}</p>
    <h2>{{ t.progress_heading }}</h2>
    <p id="points"></p>
    <div class="progress mb-2">
        <div id="points_bar" class="progress-bar" role="progressbar" style="width:0%"></div>
    </div>
    <small class="text-white">{{ t.progress_to_claim }}: <span id="progress_text"></span></small>
    <p id="conversion">{{ t.conversion_rate.format(itc=itc_per_point) }}</p>
    <ul id="progress_list" class="list-group mb-3"></ul>
    <div class="text-center mb-4">
        <button class="btn btn-success mb-2" onclick="claimReward()">{{ t.claim_reward }}</button>
        <p class="mb-0">
            {{ t.referral_link }}
            <span id="referral_link"></span>
            <button id="copy_btn" class="btn btn-sm btn-secondary ms-2 d-none" onclick="copyReferral()">{{ t.copy_link }}</button>
        </p>
    </div>
    <ul class="list-group mb-3">
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.telegram }}" target="_blank">{{ t.join_telegram_task }}</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('telegram')">{{ t.join_telegram }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.x_profile }}" target="_blank">{{ t.follow_x_task }}</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('x')">{{ t.follow_x }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.discord }}" target="_blank">{{ t.join_discord_task }}</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('discord')">{{ t.join_discord }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.web_wallet }}" target="_blank">{{ t.register_web_wallet_task }}</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('web_wallet')">{{ t.register_web_wallet }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.mobile_wallet }}" target="_blank">{{ t.register_mobile_wallet_task }}</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('mobile_wallet')">{{ t.register_mobile_wallet }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.newsletter }}" target="_blank">{{ t.subscribe_newsletter_task }}</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('newsletter')">{{ t.subscribe_newsletter }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.reddit }}" target="_blank">{{ t.follow_reddit_task }}</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('reddit')">{{ t.follow_reddit }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ links.tweet }}" target="_blank">{{ t.share_tweet_task }}</a>
            <button class="btn btn-sm btn-primary" onclick="completeTask('tweet')">{{ t.share_tweet }}</button>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ t.share_referral_task }}</span>
            <button class="btn btn-sm btn-primary" onclick="completeTask('referral_share')">{{ t.share_referral }}</button>
        </li>
    </ul>
    </div>
    <footer>
        Source code available on GitHub | <a href="https://interchained.com" target="_blank">interchained.com</a> | Interchained Labs 🧪 2025
    </footer>

    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="alertModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="countdownModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ t.claim_reward }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="countdownBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
